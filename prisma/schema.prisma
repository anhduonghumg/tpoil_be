// =======================================
// Datasource & Generator
// =======================================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// =======================================
// Enums
// =======================================
enum EmployeeStatus {
  active
  inactive
  suspended
  probation
  terminated
}

enum Gender {
  male
  female
  other
}

enum DepartmentType {
  board
  office
  group
  branch
}

enum ManagerRole {
  head
  deputy
  acting
}

enum ScopeType {
  global
  department
  site
  employee
}

enum ExportFormat {
  csv
  xlsx
  pdf
}

enum JobStatus {
  queued
  running
  done
  failed
  partial
}

enum ImportMode {
  append
  upsert
  replace
}

enum CustomerType {
  B2B
  B2C
  Distributor
  Other
}

enum CustomerRole {
  Agent
  Retail
  Wholesale
  Other
}

enum CustomerStatus {
  Active
  Inactive
  Blacklisted
}

enum TaxSource {
  Sepay
  Manual
  Other
}

enum ContractStatus {
  Draft
  Pending
  Active
  Terminated
  Cancelled
}

enum RiskLevel {
  Low
  Medium
  High
}

enum AttachmentCategory {
  ScanSigned
  Draft
  Appendix
  Other
}

enum RiskSource {
  Manual
  AutoRule
  Overdue
}

enum CronJobType {
  CONTRACT_EXPIRY_DAILY
}

enum CronJobStatus {
  SUCCESS
  FAILED
}

// =======================================
// Cron Jobs
// =======================================

model CronJob {
  id      String      @id @default(uuid()) @db.Uuid
  type    CronJobType @unique
  name    String
  enabled Boolean     @default(true)
  config  Json?

  runs CronJobRun[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CronJobRun {
  id String @id @default(uuid()) @db.Uuid

  jobId String  @db.Uuid
  job   CronJob @relation(fields: [jobId], references: [id])

  runDate DateTime

  startedAt  DateTime
  finishedAt DateTime?

  status CronJobStatus

  metrics Json?
  error   String?

  createdAt DateTime @default(now())

  @@index([jobId, runDate])
}

// =======================================
// Auth (User)
// =======================================
model User {
  id          String    @id @default(uuid()) @db.Uuid
  username    String    @unique
  email       String    @unique // work email
  password    String
  name        String?
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee     Employee?
  roleBindings UserRoleBinding[]
}

// =======================================
// Employee ‚Äì H·ªì s∆° nh√¢n s·ª±
// =======================================
model Employee {
  id   String @id @default(uuid()) @db.Uuid
  code String @unique

  userId String? @unique @db.Uuid
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  fullName      String?
  phone         String?
  workEmail     String?
  personalEmail String?        @unique
  status        EmployeeStatus @default(active)
  gender        Gender?
  nationality   String?
  maritalStatus String?

  title String?
  grade String?
  floor Int?
  desk  String?

  siteId String? @db.Uuid
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  // Self relation: nh√¢n vi√™n -> qu·∫£n l√Ω (v√† qu·∫£n l√Ω -> danh s√°ch c·∫•p d∆∞·ªõi)
  managerId    String?    @db.Uuid
  manager      Employee?  @relation("EmpManagerLine", fields: [managerId], references: [id], onDelete: SetNull)
  subordinates Employee[] @relation("EmpManagerLine")

  dob      DateTime?
  joinedAt DateTime?
  leftAt   DateTime?

  avatarUrl    String?
  accessCardId String? @unique

  addressPermanent String?
  addressCurrent   String?

  banking   Json?
  citizen   Json?
  emergency Json?
  tax       Json?

  memberships  EmployeeDepartment[]
  managerRoles DepartmentManager[]

  customersSalesOwner      Customer[] @relation("customer_sales_owner_emp")
  customersAccountingOwner Customer[] @relation("customer_accounting_owner_emp")
  customersLegalOwner      Customer[] @relation("customer_legal_owner_emp")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([status])
  @@index([deletedAt])
  @@index([code])
}

// =======================================
// Danh m·ª•c Site / Area
// =======================================
model Area {
  id    String @id @default(uuid()) @db.Uuid
  code  String @unique
  name  String
  sites Site[]
}

model Site {
  id     String  @id @default(uuid()) @db.Uuid
  code   String  @unique
  name   String
  areaId String? @db.Uuid
  area   Area?   @relation(fields: [areaId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  departments Department[]
  Employee    Employee[]
}

// =======================================
// Department ‚Äì Ph√≤ng ban nhi·ªÅu c·∫•p
// =======================================
model Department {
  id   String         @id @default(uuid()) @db.Uuid
  code String         @unique
  name String
  type DepartmentType

  parentId String?      @db.Uuid
  parent   Department?  @relation("DeptHierarchy", fields: [parentId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  children Department[] @relation("DeptHierarchy")

  siteId String? @db.Uuid
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  costCenter String?

  members  EmployeeDepartment[]
  managers DepartmentManager[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  createdBy String?
  updatedBy String?
  deletedBy String?

  @@index([parentId])
  @@index([siteId])
  @@index([deletedAt])
}

// =======================================
// Li√™n k·∫øt nh√¢n vi√™n - ph√≤ng ban (membership)
// =======================================
model EmployeeDepartment {
  id           String @id @default(uuid()) @db.Uuid
  employeeId   String @db.Uuid
  departmentId String @db.Uuid

  isPrimary Boolean   @default(false)
  startDate DateTime  @default(now())
  endDate   DateTime?

  employee   Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId, isPrimary])
  @@index([departmentId, startDate, endDate])
  @@index([employeeId, startDate, endDate])
}

// =======================================
// Qu·∫£n l√Ω tr∆∞·ªüng/ph√≥ ph√≤ng
// =======================================
model DepartmentManager {
  id           String      @id @default(uuid()) @db.Uuid
  departmentId String      @db.Uuid
  employeeId   String      @db.Uuid
  role         ManagerRole
  startDate    DateTime    @default(now())
  endDate      DateTime?

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  employee   Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([departmentId, startDate, endDate])
  @@index([employeeId, startDate, endDate])
  @@index([departmentId, role, startDate, endDate])
}

// =======================================
// RBAC + Scope
// =======================================
model Module {
  id          String       @id @default(uuid()) @db.Uuid
  code        String       @unique
  name        String
  permissions Permission[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Permission {
  id        String           @id @default(uuid()) @db.Uuid
  code      String           @unique
  name      String
  moduleId  String           @db.Uuid
  module    Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  roles     RolePermission[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([moduleId])
}

model Role {
  id        String            @id @default(uuid()) @db.Uuid
  code      String            @unique
  name      String
  desc      String?
  perms     RolePermission[]
  bindings  UserRoleBinding[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
}

model RolePermission {
  roleId       String     @db.Uuid
  permissionId String     @db.Uuid
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

model UserRoleBinding {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  roleId    String    @db.Uuid
  scopeType ScopeType
  scopeId   String?
  startAt   DateTime  @default(now())
  endAt     DateTime?

  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([userId])
  @@index([roleId])
  @@index([scopeType, scopeId])
  @@index([startAt, endAt])
}

model Customer {
  id              String         @id @default(uuid()) @db.Uuid
  code            String         @unique
  name            String
  taxCode         String?
  taxVerified     Boolean        @default(false)
  taxSource       TaxSource?
  taxSyncedAt     DateTime?
  roles           CustomerRole[]
  type            CustomerType
  billingAddress  String?
  shippingAddress String?
  contactEmail    String?
  contactPhone    String?
  creditLimit     Decimal?
  tempLimit       Decimal?
  tempFrom        DateTime?
  tempTo          DateTime?
  paymentTermDays Int?
  status          CustomerStatus @default(Active)
  note            String?

  // üëá NH√ÇN VI√äN PH·ª§ TR√ÅCH (g·∫Øn v·ªõi Employee)
  salesOwnerEmpId      String? @db.Uuid
  accountingOwnerEmpId String? @db.Uuid
  legalOwnerEmpId      String? @db.Uuid

  salesOwnerEmp      Employee? @relation("customer_sales_owner_emp", fields: [salesOwnerEmpId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  accountingOwnerEmp Employee? @relation("customer_accounting_owner_emp", fields: [accountingOwnerEmpId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  legalOwnerEmp      Employee? @relation("customer_legal_owner_emp", fields: [legalOwnerEmpId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  contacts        ContactPerson[]
  contracts       Contract[]
  riskFlags       RiskFlag[]
  creditHistories CreditLimitHistory[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([name])
  @@index([taxCode])
  @@index([salesOwnerEmpId])
  @@index([accountingOwnerEmpId])
  @@index([legalOwnerEmpId])
}

model ContactPerson {
  id         String   @id @default(uuid()) @db.Uuid
  customerId String   @db.Uuid
  customer   Customer @relation(fields: [customerId], references: [id])
  fullName   String
  position   String?
  phone      String?
  email      String?
  isPrimary  Boolean  @default(false)
}

model Contract {
  id   String @id @default(uuid()) @db.Uuid
  code String @unique
  name String

  customerId String?   @db.Uuid
  customer   Customer? @relation(fields: [customerId], references: [id])

  contractTypeId String       @db.Uuid
  contractType   ContractType @relation(fields: [contractTypeId], references: [id])

  startDate DateTime
  endDate   DateTime

  status              ContractStatus @default(Draft)
  paymentTermDays     Int?
  creditLimitOverride Decimal?
  sla                 Json?
  deliveryScope       Json?
  riskLevel           RiskLevel      @default(Low)
  approvalRequestId   String?

  renewalOfId String?    @db.Uuid
  renewalOf   Contract?  @relation("ContractRenewal", fields: [renewalOfId], references: [id])
  renewals    Contract[] @relation("ContractRenewal")

  items       ContractItem[]
  appendices  ContractAppendix[]
  attachments ContractAttachment[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([customerId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([renewalOfId])
}

model ContractType {
  id          String  @id @default(uuid()) @db.Uuid
  code        String  @unique
  name        String
  description String?
  isActive    Boolean @default(true)
  sortOrder   Int?

  contracts Contract[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model ContractAttachment {
  id          String             @id @default(uuid()) @db.Uuid
  contractId  String             @db.Uuid
  contract    Contract           @relation(fields: [contractId], references: [id])
  fileName    String
  fileUrl     String?
  externalUrl String?
  category    AttachmentCategory
}

model ContractItem {
  id         String   @id @default(uuid()) @db.Uuid
  contractId String   @db.Uuid
  contract   Contract @relation(fields: [contractId], references: [id])
  productId  String   @db.Uuid
  uom        String
  price      Decimal
  minQty     Decimal?
  maxQty     Decimal?
  discount   Decimal?
  taxRate    Decimal?
  note       String?
}

model ContractAppendix {
  id            String   @id @default(uuid()) @db.Uuid
  contractId    String   @db.Uuid
  contract      Contract @relation(fields: [contractId], references: [id])
  code          String
  effectiveDate DateTime
  changeSummary String?
  docUrl        String?
}

model CreditLimitHistory {
  id         String    @id @default(uuid()) @db.Uuid
  customerId String    @db.Uuid
  customer   Customer  @relation(fields: [customerId], references: [id])
  oldLimit   Decimal?
  newLimit   Decimal?
  tempLimit  Decimal?
  tempFrom   DateTime?
  tempTo     DateTime?
  reason     String?
  changedBy  String
  changedAt  DateTime  @default(now())
}

model RiskFlag {
  id         String     @id @default(uuid()) @db.Uuid
  customerId String     @db.Uuid
  customer   Customer   @relation(fields: [customerId], references: [id])
  level      RiskLevel
  source     RiskSource
  message    String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  deletedAt  DateTime?
}

// =======================================
// Audit Log
// =======================================
model AuditLog {
  id String @id @default(uuid()) @db.Uuid

  // request-level
  requestId  String?  @db.Uuid
  at         DateTime @default(now())
  userId     String?  @db.Uuid
  ip         String?
  ua         String?
  method     String?
  path       String?
  statusCode Int?

  // business-level
  moduleCode String?
  permission String?
  action     String?
  entityId   String?    @db.Uuid
  scopeType  ScopeType?
  scopeId    String?    @db.Uuid

  // data snapshots
  before Json?
  after  Json?
  diff   Json?
  error  Json?

  @@index([userId, at])
  @@index([moduleCode, action, at])
  @@index([entityId])
}

// =======================================
// Export / Import Jobs
// =======================================
model ExportJob {
  id         String       @id @default(uuid()) @db.Uuid
  moduleCode String
  format     ExportFormat
  filter     Json?
  status     JobStatus    @default(queued)
  fileUrl    String?
  error      String?

  createdBy  String
  createdAt  DateTime  @default(now())
  finishedAt DateTime?

  @@index([moduleCode, status, createdBy, createdAt])
}

model ImportJob {
  id         String     @id @default(uuid()) @db.Uuid
  moduleCode String
  mode       ImportMode
  mapping    Json?
  status     JobStatus  @default(queued)
  total      Int?
  success    Int?
  failed     Int?
  srcFileUrl String?
  reportUrl  String?
  error      String?

  createdBy  String
  createdAt  DateTime  @default(now())
  finishedAt DateTime?

  @@index([moduleCode, status, createdBy, createdAt])
}

model LoginAttempt {
  id        String   @id @default(uuid()) @db.Uuid
  email     String
  ok        Boolean
  ip        String?
  ua        String?
  createdAt DateTime @default(now())
}
